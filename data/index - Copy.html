<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1"
    />
    <title>ESP32-C3 Quickshifter</title>

    <style>
      :root {
        --bg: #0b0f10;
        --card: #11161a;
        --muted: #2a3238;
        --text: #e8eef2;
        --sub: #a6b3bd;
        --accent: #f3c316;
        --primary: #1e88ff;
        --danger: #ff4d4d;
        --ok: #18c37e;
        --br: 14px;
        --pad: 12px;
        --gap: 10px;
        --shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0b0f10, #0e1418);
        color: var(--text);
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 5;
        background: linear-gradient(90deg, #0b0f10, #0e1418);
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid #182127;
        box-shadow: var(--shadow);
      }
      header .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 12px var(--accent);
      }
      header h1 {
        font-size: 18px;
        margin: 0;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      header .sp {
        flex: 1;
      }
      header .btn-danger {
        background: var(--danger);
        border: none;
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      main {
        padding: 16px;
        display: grid;
        gap: var(--gap);
        grid-template-columns: 1fr;
      }
      .card {
        background: var(--card);
        border: 1px solid #1b242b;
        border-radius: var(--br);
        padding: var(--pad);
        box-shadow: var(--shadow);
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .tab-btn {
        border: 1px solid #22303a;
        background: #0f151a;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .tab-btn.active {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(30, 136, 255, 0.25);
      }
      .row {
        display: grid;
        gap: var(--gap);
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 13px;
        color: var(--sub);
      }
      input,
      select {
        background: #0f151a;
        color: #fff;
        border: 1px solid #24323b;
        border-radius: 10px;
        padding: 8px 10px;
        outline: none;
      }
      input:focus,
      select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(30, 136, 255, 0.25);
      }
      .btn {
        border: 1px solid #22303a;
        background: #121a1f;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn.primary {
        border-color: var(--primary);
        background: #0f1720;
      }
      .btn.accent {
        border-color: #f3c316;
        background: #17160a;
      }
      .btn.ok {
        border-color: #18c37e;
        background: #0f1915;
      }
      .btn.danger {
        border-color: #ff4d4d;
        background: #1c1010;
      }
      .table {
        overflow: auto;
        border-radius: 12px;
        border: 1px solid #22303a;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #1e2a32;
        text-align: left;
      }
      pre {
        white-space: pre-wrap;
        background: #0a0f12;
        border: 1px solid #1b242b;
        border-radius: 12px;
        padding: 10px;
        max-height: 260px;
        overflow: auto;
      }
      .muted {
        color: var(--sub);
      }
      @media (min-width: 900px) {
        main {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>

  <body>
    <!-- ====================== HEADER ====================== -->
    <header>
      <div class="dot"></div>
      <h1>Tự làm điện tử — Quickshifter</h1>
      <div class="sp"></div>
      <button id="btnWifiOff" class="btn-danger">Tắt Wi-Fi</button>
    </header>

    <!-- ======================= BODY ======================= -->
    <main>
      <div class="card">
        <!-- -------- Tabs -------- -->
        <div class="tabs">
          <button id="t_qs" class="tab-btn active">Quickshifter</button>
          <button id="t_bf" class="tab-btn">Backfire</button>
          <button id="t_tools" class="tab-btn">Tools & Logs</button>
          <button id="t_wifi" class="tab-btn">Wi‑Fi & OTA</button>
          <button id="t_lock" class="tab-btn">Lock</button>
        </div>

        <!-- ========== TAB: QUICKSHIFTER ========== -->
        <section id="qs">
          <!-- Controls -->
          <div class="row">
            <label>
              Mode
              <select id="mode">
                <option value="0">Manual</option>
                <option value="1">Auto</option>
              </select>
            </label>

            <label>
              Cut Output
              <select id="cutout">
                <option value="0">Ignition</option>
                <option value="1">Injector</option>
              </select>
            </label>

            <label>
              RPM Source
              <select id="rsrc">
                <option value="0">Coil</option>
                <option value="1">Injector</option>
              </select>
            </label>

            <label>
              PPR
              <select id="ppr">
                <option>0.5</option>
                <option selected>1</option>
                <option>2</option>
              </select>
            </label>

            <label>RPM min <input id="rpmmin" type="number" value="2500" /></label>
            <label>Manual kill (ms) <input id="mkill" type="number" value="70" /></label>
            <label>Debounce shift (ms) <input id="deb" type="number" value="15" /></label>
            <label>Hold-off (ms) <input id="hold" type="number" value="200" /></label>
          </div>

          <!-- Live RPM Gauge -->
          <div id="rpmCard" class="card" style="margin-top: 10px">
            <h3>Live RPM</h3>

            <div class="rpm-wrap" style="display: grid; place-items: center; padding: 10px">
  <svg
    id="rpmGauge"
    viewBox="0 0 240 240"
    width="100%"
    style="max-width: 420px"
  >
<!-- track (8h → 3h, cung dài 210°) -->
<path
  id="trackPath"
  fill="none"
  stroke="#24323B"
  stroke-width="16"
  stroke-linecap="round"
  d="M 42.060 165.000 A 90 90 0 1 1 210.000 120.000"
/>
<g id="rpmTicks" stroke="#2A3238"></g>

<!-- value arc (8h → 3h) -->
<path
  id="rpmArc"
  fill="none"
  stroke="#1E88FF"
  stroke-width="16"
  stroke-linecap="round"
  stroke-dasharray="0 999"
  d="M 42.060 165.000 A 90 90 0 1 1 210.000 120.000"
/>



    <!-- kim -->
    <line
      id="rpmNeedle"
      x1="120"
      y1="120"
      x2="120"
      y2="35"
      stroke="#FFEB3B"
      stroke-width="4"
      stroke-linecap="round"
      
          
    ></line>

    <!-- tâm kim -->
    <circle cx="120" cy="120" r="6" fill="#FFEB3B"></circle>

    <!-- nhãn RPM -->
    <text
      id="rpmValue"
      x="120"
      y="200"
      text-anchor="middle"
      fill="#fff"
      font-size="20"
      font-weight="bold"
    >0 rpm</text>
  </svg>
</div>


              <div style="margin-top: 6px; font-size: 28px; font-weight: 700">
                <span id="rpmText">0</span>
                <span style="font-size: 14px; color: #a6b3bd">rpm</span>
              </div>
            </div>
          </div>

          
<!-- Auto Map -->
          <div class="card" style="margin-top: 10px">
            <h3>Auto Map</h3>
            <div class="table">
              <table>
                <thead>
                  <tr>
                    <th>Lo</th>
                    <th>Hi</th>
                    <th>Cut (ms)</th>
                  </tr>
                </thead>
                <tbody id="map"></tbody>
              </table>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 8px">
              <button id="btnAddRow" class="btn accent">Thêm dòng</button>
              <button id="btnSave" class="btn ok">Lưu</button>
              <button id="btnLoad" class="btn">Tải</button>
            </div>
          </div>
        </section>

        <!-- ========== TAB: BACKFIRE ========== -->
        <section id="bf" style="display:none">
  <div class="row">
    <label><span>Enable</span><input id="bf_enable" type="checkbox" /></label>
    <label><span>IGN only</span><input id="bf_ign_only" type="checkbox" checked /></label>

    <label>Mode
      <div style="display:flex; gap:12px; align-items:center">
        <label><input id="bf_mode_shift"   type="checkbox" checked /> SHIFT</label>
        <label><input id="bf_mode_overrun" type="checkbox" checked /> OVERRUN</label>
      </div>
    </label>

    <label>RPM min <input id="bf_rpm_min" type="number" value="4500" /></label>
    <label>RPM max <input id="bf_rpm_max" type="number" value="9000" /></label>
    <label>Warmup (s) <input id="bf_warmup_s" type="number" value="120" /></label>

    <label>Decel threshold (rpm/s)
      <input id="bf_decel_thresh" type="number" value="3000" />
    </label>
    <label>Window after shift (ms)
      <input id="bf_window_ms" type="number" value="250" />
    </label>

    <label>Burst count <input id="bf_burst_count" type="number" value="3" /></label>
    <label>Burst ON (ms) <input id="bf_burst_on" type="number" value="25" /></label>
    <label>Burst OFF (ms) <input id="bf_burst_off" type="number" value="75" /></label>
    <label>Refractory (ms) <input id="bf_refractory_ms" type="number" value="1500" /></label>
  </div>

  <div style="margin-top:8px">
    <button id="btnSaveBF" class="btn ok">Lưu</button>
  </div>
</section>


        <!-- ========== TAB: TOOLS & LOGS ========== -->
        <section id="tools" style="display: none">
          <div class="row">
            <div class="card">
              <h3>Test Output</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <button id="btnTestIgn" class="btn primary">Cắt IGN 50ms</button>
                <button id="btnTestInj" class="btn primary">Cắt INJ 50ms</button>
              </div>
            </div>

            <div class="card">
              <h3>Test RPM</h3>
              <div class="row">
                <label>Enable <input id="tr_en" type="checkbox" /></label>
                <label>RPM <input id="tr_rpm" type="number" value="5000" /></label>
                <label>
                  PPR
                  <select id="tr_ppr">
                    <option>0.5</option>
                    <option selected>1</option>
                    <option>2</option>
                  </select>
                </label>
              </div>

              <div style="margin-top: 8px">
                <button id="btnApplyTR" class="btn ok">Apply</button>
              </div>
            </div>

            <div class="card">
              <h3>Calibrate RPM</h3>
              <div class="row">
                <label>RPM thực tế <input id="cal_true" type="number" /></label>
              </div>

              <div style="margin-top: 8px">
                <button id="btnCalib" class="btn ok">Calibrate</button>
              </div>
            </div>

            <div class="card">
              <h3>Config</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap">
                <button id="btnExport" class="btn">Export JSON</button>
                <input id="f" class="btn" type="file" accept=".json" />
                <button id="btnReload" class="btn">Reload</button>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Logs</h3>
            <pre id="logs" class="muted"></pre>
            <div>
              <button id="btnClearLog" class="btn danger">Clear</button>
            </div>
          </div>
        </section>

        <!-- ========== TAB: WI-FI & OTA ========== -->
        <section id="wifi" style="display:none">
          <div class="row">
            <div class="card">
              <h3>Wi‑Fi AP</h3>
              <div class="row">
                <label>SSID <input id="ap_ssid" placeholder="auto SSID if empty" /></label>
                <label>Password <input id="ap_pass" type="password" placeholder="min 8 chars" /></label>
              </div>
              <div style="margin-top:8px">
                <button id="btnWifiSave" class="btn ok">Save Wi‑Fi</button>
              </div>
            </div>

            <div class="card">
              <h3>OTA Update</h3>
              <div>
                <label>Firmware (.bin)
                  <input type="file" id="fw_file" accept=".bin" />
                </label>
                <progress id="fw_prog" max="100" value="0" style="width:100%"></progress>
                <button id="btnFwUpload" class="btn">Upload FW</button>
                <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
                  <button id="btnRestoreFwLast" class="btn danger">Restore FW (Last)</button>
                  <button id="btnRestoreFwOrig" class="btn">Restore FW (Original)</button>
                </div>
              </div>
              <hr/>
              <div>
                <label>FS Image (.bin)
                  <input type="file" id="fs_file" accept=".bin" />
                </label>
                <progress id="fs_prog" max="100" value="0" style="width:100%"></progress>
                <button id="btnFsUpload" class="btn">Upload FS</button>
                <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
                  <button id="btnRestoreFsLast" class="btn danger">Restore FS (Last)</button>
                  <button id="btnRestoreFsOrig" class="btn">Restore FS (Original)</button>
                </div>
              </div>
              <div style="margin-top:8px">
                <a class="btn" href="/ota">Open basic OTA page</a>
              </div>
            </div>
          </div>
        </section>

        <!-- ========== TAB: LOCK ========== -->
        <section id="lock" style="display: none">
          <div class="row">
            <div class="card">
              <h3>Vehicle Lock</h3>
              <div class="row" style="align-items:center">
                <span class="muted">•</span>
                <span id="lockStateText" class="muted">Unknown</span>
                <button id="btnLockRefresh" class="btn" style="margin-left:auto">Refresh</button>
              </div>
            </div>

            <div class="card">
              <h3>Cấu hình</h3>
              <div class="row">
                <label><span>Enable Lock khi cấp nguồn</span><input id="lock_enabled" type="checkbox" /></label>
                <label>Cut on lock
                  <select id="lock_cut_sel">
                    <option value="ign">Ignition</option>
                    <option value="inj">Injector</option>
                  </select>
                </label>
                <label>Short max (ms) <input id="lock_short_ms_max" type="number" value="300" /></label>
                <label>Long min (ms)  <input id="lock_long_ms_min"  type="number" value="600" /></label>
                <label>Gap (ms)       <input id="lock_gap_ms"       type="number" value="400" /></label>
                <label>Timeout (s)    <input id="lock_timeout_s"    type="number" value="30" /></label>
                <label>Max retries    <input id="lock_max_retries"  type="number" value="5" /></label>
              </div>
              <div style="margin-top:8px">
                <button id="btnLockSaveCfg" class="btn ok">Save Lock</button>
                <span id="msgLockCfg" class="muted"></span>
              </div>
            </div>

            <div class="card">
              <h3>Điều khiển</h3>
              <div class="row" style="gap:10px; align-items:center">
                <button id="btnLockNow" class="btn danger">Lock Now</button>
                <span class="muted">→ Cắt theo “Cut on lock”</span>
              </div>
              <div class="row" style="gap:10px">
                <input id="unlock_pass" placeholder="Pass 0/1 (vd: 1001)" maxlength="8" />
                <button id="btnUnlockPass" class="btn">Unlock (Pass)</button>
              </div>
              <hr>
              <h4>Set / Change Pass</h4>
              <div class="row" style="gap:10px">
                <input id="old_pass" placeholder="Current pass (0/1)" maxlength="8" />
                <input id="new_pass" placeholder="New pass (0/1)" maxlength="8" />
                <input id="new_pass2" placeholder="Repeat new pass" maxlength="8" />
              </div>
              <div class="row">
                <button id="btnLockSet" class="btn">Set Pass</button>
                <button id="btnLockChange" class="btn">Change Pass</button>
                <span id="msgLockPass" class="muted"></span>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>

    <!-- ===================== SCRIPTS ===================== -->
    <script>
      /* ---------- Helpers + Tabs ---------- */
      const q = (s) => document.querySelector(s);
      const qa = (s) => [...document.querySelectorAll(s)];

      const tabs = { qs: q("#qs"), bf: q("#bf"), tools: q("#tools"), wifi: q("#wifi"), lock: q("#lock") };
      const tb = { qs: q("#t_qs"), bf: q("#t_bf"), tools: q("#t_tools"), wifi: q("#t_wifi"), lock: q("#t_lock") };

      function setTab(id) {
        for (const k in tabs) {
          tabs[k].style.display = k === id ? "block" : "none";
          tb[k].classList.toggle("active", k === id);
        }
      }
      tb.qs.onclick = () => setTab("qs");
      tb.bf.onclick = () => setTab("bf");
      tb.tools.onclick = () => setTab("tools");
      tb.wifi.onclick  = () => setTab("wifi");
      tb.lock.onclick  = () => setTab("lock");

      async function apiGet(p) {
        const r = await fetch(p);
        return r.ok ? r.json() : null;
      }
      async function apiText(p, o) {
        const r = await fetch(p, o);
        return r.text();
      }

      async function hold() {
        try {
          await apiText("/api/wifi_hold?on=1", { method: "POST" });
      // Lock tab hookup
      q("#t_lock")?.addEventListener("click", ()=> setTab("lock"));
        } catch (e) {}
      }
      async function wifiOff() {
        if (confirm("Tắt Wi-Fi AP ngay?")) {
          await apiText("/api/wifi_off", { method: "POST" });
        }
      }
      q("#btnWifiOff").onclick = wifiOff;

      /* ---------- Config load/save ---------- */
      let cfg = {};

      function renderCfg() {
        q("#mode").value = cfg.mode;
        q("#cutout").value = cfg.cut_output;
        q("#rsrc").value = cfg.rpm_source;
        q("#ppr").value = cfg.ppr;
        q("#rpmmin").value = cfg.rpm_min;
        q("#mkill").value = cfg.manual_kill_ms;
        q("#deb").value = cfg.debounce_shift_ms;
        q("#hold").value = cfg.holdoff_ms;

        // legacy backfire fields are optional; advanced fields below are primary
        // --- Backfire ---
q("#bf_enable").checked      = !!cfg.bf_enable;
q("#bf_ign_only").checked    = cfg.bf_ign_only ?? true;

q("#bf_mode_shift").checked   = (cfg.bf_mode ?? 3) & 0x01;
q("#bf_mode_overrun").checked = (cfg.bf_mode ?? 3) & 0x02;

q("#bf_rpm_min").value      = cfg.bf_rpm_min ?? 4500;
q("#bf_rpm_max").value      = cfg.bf_rpm_max ?? 9000;
q("#bf_warmup_s").value     = cfg.bf_warmup_s ?? 120;

q("#bf_decel_thresh").value = cfg.bf_decel_thresh ?? 3000;
q("#bf_window_ms").value    = cfg.bf_window_ms ?? 250;

q("#bf_burst_count").value  = cfg.bf_burst_count ?? 3;
q("#bf_burst_on").value     = cfg.bf_burst_on ?? 25;
q("#bf_burst_off").value    = cfg.bf_burst_off ?? 75;
q("#bf_refractory_ms").value= cfg.bf_refractory_ms ?? 1500;

        const tb = q("#map");
        tb.innerHTML = "";
        let arr = (cfg.map || []);
        if (!arr.length) {
          arr = [
            { lo: 2500, hi: 4000, t: 85 },
            { lo: 4000, hi: 7000, t: 65 },
            { lo: 7000, hi:10000, t: 50 },
            { lo:10000, hi:20000, t: 45 }
          ];
        }
        arr.forEach((b) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="number" value="${b.lo}"></td>
            <td><input type="number" value="${b.hi}"></td>
            <td><input type="number" value="${b.t}"></td>`;
          tb.appendChild(tr);
        });
      }

      function collectCfg() {
        cfg.mode = +q("#mode").value;
        cfg.cut_output = +q("#cutout").value;
        cfg.rpm_source = +q("#rsrc").value;
        cfg.ppr = parseFloat(q("#ppr").value);
        cfg.rpm_min = +q("#rpmmin").value;
        cfg.manual_kill_ms = +q("#mkill").value;
        cfg.debounce_shift_ms = +q("#deb").value;
        cfg.holdoff_ms = +q("#hold").value;

        // legacy backfire fields (if present)
        if (q("#bf_en")) cfg.backfire_enabled = q("#bf_en").checked;
        if (q("#bf_ex")) cfg.backfire_extra_ms = +q("#bf_ex").value;
        if (q("#bf_min")) cfg.backfire_min_rpm = +q("#bf_min").value;
        // --- Backfire ---
let mode = 0;
if (q("#bf_mode_shift").checked)   mode |= 0x01;   // BF_SHIFT
if (q("#bf_mode_overrun").checked) mode |= 0x02;   // BF_OVERRUN

cfg.bf_enable        = q("#bf_enable").checked ? 1 : 0;
cfg.bf_ign_only      = q("#bf_ign_only").checked ? 1 : 0;
cfg.bf_mode          = mode;

cfg.bf_rpm_min       = +q("#bf_rpm_min").value;
cfg.bf_rpm_max       = +q("#bf_rpm_max").value;
cfg.bf_warmup_s      = +q("#bf_warmup_s").value;

cfg.bf_decel_thresh  = +q("#bf_decel_thresh").value;
cfg.bf_window_ms     = +q("#bf_window_ms").value;

cfg.bf_burst_count   = +q("#bf_burst_count").value;
cfg.bf_burst_on      = +q("#bf_burst_on").value;
cfg.bf_burst_off     = +q("#bf_burst_off").value;
cfg.bf_refractory_ms = +q("#bf_refractory_ms").value;
q("#btnSaveBF").onclick = save;


        cfg.map = [];
        document.querySelectorAll("#map tr").forEach((tr) => {
          const t = tr.querySelectorAll("input");
          cfg.map.push({ lo: +t[0].value, hi: +t[1].value, t: +t[2].value });
        });
      }

      async function load() {
        const d = await apiGet("/api/get");
        if (d) {
          cfg = d;
          renderCfg();
          // Load Wi‑Fi
          const w = await apiGet('/api/wifi_get');
          if (w){ q('#ap_ssid').value = w.ap_ssid || ''; q('#ap_pass').value = ''; }
        }
      }
      async function save() {
        collectCfg();
        alert(await apiText("/api/set", { method: "POST", body: JSON.stringify(cfg) }));
      }

      q("#btnAddRow").onclick = () => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td><input type="number"></td><td><input type="number"></td><td><input type="number"></td>';
        q("#map").appendChild(tr);
      };
      q("#btnSave").onclick = save;
      q("#btnLoad").onclick = load;
      q("#btnSaveBF").onclick = save;
      q("#btnReload").onclick = load;

      // Wi‑Fi/OTA handlers
      q('#btnWifiSave').onclick = async ()=>{
        const body = { ap_ssid: q('#ap_ssid').value.trim(), ap_pass: q('#ap_pass').value };
        const t = await apiText('/api/wifi_set', {method:'POST', body: JSON.stringify(body)});
        alert(t||'OK');
      };
      function uploadWithProgress(url, file, prog){
        return new Promise((res, rej)=>{
          const xhr = new XMLHttpRequest();
          xhr.open('POST', url, true);
          xhr.upload.onprogress = (e)=>{ if (e.lengthComputable) prog.value = Math.round(100*e.loaded/e.total); };
          xhr.onload = ()=>{ res(xhr.responseText); };
          const fd = new FormData();
          fd.append('update', file);
          xhr.send(fd);
        });
      }
      q('#btnFwUpload').onclick = async ()=>{
        const f = q('#fw_file').files[0]; if (!f) return alert('Chọn file FW');
        q('#fw_prog').value = 0; const t = await uploadWithProgress('/api/ota/firmware', f, q('#fw_prog'));
        alert(t||'Done');
      };
      q('#btnFsUpload').onclick = async ()=>{
        const f = q('#fs_file').files[0]; if (!f) return alert('Chọn file FS');
        q('#fs_prog').value = 0; const t = await uploadWithProgress('/api/ota/fsimage', f, q('#fs_prog'));
        alert(t||'Done');
      };

      // restore buttons
      q('#btnRestoreFwLast').onclick = ()=> apiText('/api/ota/restore?what=fw&which=last');
      q('#btnRestoreFwOrig').onclick = ()=> apiText('/api/ota/restore?what=fw&which=orig');
      q('#btnRestoreFsLast').onclick = ()=> apiText('/api/ota/restore?what=fs&which=last');
      q('#btnRestoreFsOrig').onclick = ()=> apiText('/api/ota/restore?what=fs&which=orig');

      q("#btnExport").onclick = () => {
        const s = JSON.stringify(cfg, null, 2);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([s], { type: "application/json" }));
        a.download = "qs_config.json";
        a.click();
      };
      q("#f").onchange = async (e) => {
        const t = await e.target.files[0].text();
        alert(await apiText("/api/set", { method: "POST", body: t }));
        load();
      };

      /* ---------- Tools ---------- */
      q("#btnTestIgn").onclick = () => apiText("/api/testcut?out=ign", { method: "POST" });
      q("#btnTestInj").onclick = () => apiText("/api/testcut?out=inj", { method: "POST" });
      q("#btnApplyTR").onclick = () => {
        const en = q("#tr_en").checked ? 1 : 0;
        const rpm = q("#tr_rpm").value;
        const ppr = q("#tr_ppr").value;
        return apiText(`/api/testrpm?en=${en}&rpm=${rpm}&ppr=${ppr}`, { method: "POST" });
      };
      q("#btnCalib").onclick = () => {
        const v = q("#cal_true").value;
        if (!v) return alert("Nhập RPM thực tế");
        return apiText(`/api/calib?true_rpm=${v}`, { method: "POST" }).then((t) => alert(t));
      };

      /* ---------- Logs ---------- */
      async function loadLogs() {
        try {
          const a = await apiGet("/api/log");
          if (!a) return;
          const out = a
            .map(
              (x) =>
                `[${x.t}] rpm=${x.rpm} cut=${x.cut}ms ${x.auto ? "AUTO" : "MAN"} ${
                  x.bf ? "BF" : ""
                } out=${x.out} why=${x.why}`
            )
            .join("\n");
          const pre = q("#logs");
          pre.textContent = out;
          pre.scrollTop = pre.scrollHeight;
        } catch (e) {}
      }
      q("#btnClearLog").onclick = () => apiText("/api/clearlog", { method: "POST" });

      /* ---------- Live RPM Gauge (8h → 3h, 0→14k) ---------- */
      let rpmSmooth = 0;
      const rpmAlpha = 0.35;
      /*
      const GA = {
        CX: 110,
        CY: 110,
        R: 90,
        START: 240, // 8 giờ
        END: 0, // 3 giờ
        // 
        */
 const GA = {
  CX: 120,
  CY: 120,
  R: 90,
  START: 150,   // 0 rpm ở vị trí 8 giờ
  END: 0,      // max rpm ở ~2 giờ
  SWEEP: 0,     // sẽ tính ở configureGauge
  LEN: 1,
  MAX: 14000,
  RED_FROM: 12000,
};

/*
      function longSweep(start, end) {
        let s = ((end - start) % 360 + 360) % 360;
        if (s < 180) s += 360;
        return s;
      }
*/
function longSweep(start, end) {
  // cwShort = độ quét ngắn theo chiều kim đồng hồ (0..360)
  const cwShort = ((end - start) % 360 + 360) % 360;
  // long arc = 360 - cwShort (>=180)
  return cwShort < 180 ? 360 - cwShort : cwShort;
}

      function arcPath(cx, cy, r, sd, ed, forceLong = true) {
        const sr = (sd * Math.PI) / 180;
        const er = (ed * Math.PI) / 180;

        const x1 = cx + r * Math.cos(sr);
        const y1 = cy + r * Math.sin(sr);
        const x2 = cx + r * Math.cos(er);
        const y2 = cy + r * Math.sin(er);

        const laf = forceLong ? 1 : ((ed - sd + 360) % 360 > 180 ? 1 : 0);
        const swf = 1;

        return `M ${x1.toFixed(3)} ${y1.toFixed(3)} A ${r} ${r} 0 ${laf} ${swf} ${x2.toFixed(
          3
        )} ${y2.toFixed(3)}`;
      }

      function configureGauge({ start, end, max, redFrom = null }) {
        GA.START = start;
        GA.END = end;
        GA.MAX = max;
        GA.RED_FROM = redFrom;
        GA.SWEEP = longSweep(GA.START, GA.END);

        const track = q("#trackPath");
        const arc = q("#rpmArc");
        if (!track || !arc) return;

        const d = arcPath(GA.CX, GA.CY, GA.R, GA.START, GA.END, true);
        track.setAttribute("d", d);
        arc.setAttribute("d", d);

        GA.LEN = arc.getTotalLength ? arc.getTotalLength() : Math.PI * GA.R * (GA.SWEEP / 180);

        // ticks 2k
        const g = q("#rpmTicks");
        if (g) {
          g.innerHTML = "";
          const step = 2000;
          for (let v = 0; v <= GA.MAX; v += step) {
            const t = v / GA.MAX;
           // const a = (GA.START + GA.SWEEP * t) % 360;
            const a = (GA.START + GA.SWEEP * (v / GA.MAX)) % 360;
            
            
  q("#rpmNeedle").setAttribute("transform", `rotate(${a} ${GA.CX} ${GA.CY})`);


            const rad = (a * Math.PI) / 180;

            const x1 = GA.CX + Math.cos(rad) * (GA.R - 14);
            const y1 = GA.CY + Math.sin(rad) * (GA.R - 14);
            const x2 = GA.CX + Math.cos(rad) * GA.R;
            const y2 = GA.CY + Math.sin(rad) * GA.R;

            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            g.appendChild(line);

            const tx = GA.CX + Math.cos(rad) * (GA.R - 28);
            const ty = GA.CY + Math.sin(rad) * (GA.R - 28);
            const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
            txt.setAttribute("x", tx);
            txt.setAttribute("y", ty);
            txt.setAttribute("fill", "#A6B3BD");
            txt.setAttribute("font-size", "10");
            txt.setAttribute("text-anchor", "middle");
            txt.setAttribute("dominant-baseline", "middle");
            txt.textContent = v / 1000 + "k";
            g.appendChild(txt);
          }
        }

      // ---- redline overlay (đừng để trùng khối này) ----

/*
if (redFrom != null && redFrom < GA.MAX) {
  // vị trí bắt đầu vùng đỏ theo cấu hình cung hiện tại
  const a1 = (GA.START + GA.SWEEP * (redFrom / GA.MAX)) % 360;
  // vẽ từ a1 -> GA.END theo cung dài
  red.setAttribute("d", arcPath(GA.CX, GA.CY, GA.R, a1, GA.END, true));
  red.style.display = "";
} else {
  red.style.display = "none";
}*/
      }

/*
      function setGauge(rpm) {
        rpmSmooth = rpmSmooth ? rpmSmooth * (1 - rpmAlpha) + rpm * rpmAlpha : rpm;
        const v = Math.max(0, Math.min(GA.MAX, rpmSmooth));

        const txt = q("#rpmText");
        if (txt) txt.textContent = Math.round(v);

        const a = (GA.START + GA.SWEEP * (v / GA.MAX)) % 360;
        const needle = q("#rpmNeedle");
        if (needle) needle.setAttribute("transform", `translate(${GA.CX},${GA.CY}) rotate(${a})`);

        const arc = q("#rpmArc");
        if (arc) {
          const len = GA.LEN * (v / GA.MAX);
          arc.setAttribute("stroke-dasharray", `${len} ${Math.max(1, GA.LEN - len)}`);
          arc.setAttribute(
            "stroke",
            GA.RED_FROM != null && v >= GA.RED_FROM ? "#FF6B6B" : "#1E88FF"
          );
        }
      }
*/

function setGauge(rpm) {
  // khôi phục smoothing + clamp để tạo v
  rpmSmooth = rpmSmooth ? rpmSmooth * (1 - rpmAlpha) + rpm * rpmAlpha : rpm;
  const v = Math.max(0, Math.min(GA.MAX, rpmSmooth));
  const t = v / GA.MAX; // 0..1

  // kim: 240° -> 90° theo chiều kim đồng hồ, không đụng GA.START/END
  // sweepCW(240,90) = 210°
  const a = (240 + ((90 - 240 + 360) % 360) * t) % 360;
  q("#rpmNeedle").setAttribute("transform", `rotate(${a} ${GA.CX} ${GA.CY})`);

  // cập nhật arc theo t (giữ nguyên track/ticks)
  const arc = q("#rpmArc");
  if (arc) {
    const len = GA.LEN * t;
    arc.setAttribute("stroke-dasharray", `${len} ${Math.max(1, GA.LEN - len)}`);
    arc.setAttribute("stroke", GA.RED_FROM != null && v >= GA.RED_FROM ? "#FF6B6B" : "#1E88FF");
  }

  // cập nhật số RPM hiển thị
  const txt = q("#rpmText");    if (txt) txt.textContent = Math.round(v);
  const val = q("#rpmValue");   if (val) val.textContent = `${Math.round(v)} rpm`;
}


      async function pollRPM() {
        try {
          const r = await fetch("/api/rpm");
          if (!r.ok) return;
          const j = await r.json();
          if (typeof j.rpm === "number") setGauge(j.rpm);
        } catch (e) {}
      }

      
      /* ---------- Lock helpers ---------- */
      const only01 = (s)=> (s||"").replace(/[^01]/g,"").slice(0,8);
      async function lockState(){
        try{ const r = await apiGet("/api/lock_state"); if(!r) return;
          q("#lockStateText").textContent = r.locked? "LOCKED":"UNLOCKED";
        }catch(e){}
      }
      q("#btnLockRefresh")?.addEventListener("click", lockState);
      q("#btnLockSaveCfg")?.addEventListener("click", async ()=>{
        const body = {
          lock_enabled: q("#lock_enabled").checked,
          lock_cut_sel: q("#lock_cut_sel").value,
          lock_short_ms_max: +q("#lock_short_ms_max").value,
          lock_long_ms_min:  +q("#lock_long_ms_min").value,
          lock_gap_ms:       +q("#lock_gap_ms").value,
          lock_timeout_s:    +q("#lock_timeout_s").value,
          lock_max_retries:  +q("#lock_max_retries").value
        };
        q("#msgLockCfg").textContent = await apiText("/api/set", {method:"POST", body: JSON.stringify(body)});
        setTimeout(()=> q("#msgLockCfg").textContent="", 1200);
      });
      q("#btnLockNow")?.addEventListener("click", async ()=>{
        await apiText("/api/lock_cmd", {method:"POST", body: JSON.stringify({cmd:"lock"})});
        lockState();
      });
      q("#btnUnlockPass")?.addEventListener("click", async ()=>{
        const code = only01(q("#unlock_pass").value);
        if (!code){ q("#msgLockPass").textContent="Pass 0/1"; setTimeout(()=> q("#msgLockPass").textContent="", 1200); return; }
        const t = await apiText("/api/lock_cmd", {method:"POST", body: JSON.stringify({cmd:"unlock", pass: code})});
        q("#msgLockPass").textContent = t || "OK";
        lockState();
        setTimeout(()=> q("#msgLockPass").textContent="", 1200);
      });
      q("#btnLockSet")?.addEventListener("click", async ()=>{
        const np = only01(q("#new_pass").value);
        if (!np){ q("#msgLockPass").textContent="New pass 0/1"; setTimeout(()=> q("#msgLockPass").textContent="", 1200); return; }
        const t = await apiText("/api/set", {method:"POST", body: JSON.stringify({lock_code: np})});
        q("#msgLockPass").textContent = t || "Set OK";
        setTimeout(()=> q("#msgLockPass").textContent="", 1200);
      });
      q("#btnLockChange")?.addEventListener("click", async ()=>{
        const op = only01(q("#old_pass").value);
        const np1 = only01(q("#new_pass").value);
        const np2 = only01(q("#new_pass2").value);
        if (!op || !np1 || np1!==np2){ q("#msgLockPass").textContent="Kiểm tra pass"; setTimeout(()=> q("#msgLockPass").textContent="", 1200); return; }
        const t = await apiText("/api/lock_change_pass", {method:"POST", body: JSON.stringify({old: op, neo: np1})});
        q("#msgLockPass").textContent = t || "Đổi OK";
        setTimeout(()=> q("#msgLockPass").textContent="", 1200);
      });

      // ---------- Init ----------
      (async () => {
        setTab("qs");
        await hold();
        await load();
        setInterval(loadLogs, 1000); // logs
        lockState();
      })();

      // Gauge config + polling
     // nếu bạn có phần cấu hình góc:
configureGauge({ start: GA.START, end: GA.END, max: 14000, redFrom: 12000 });
rpmSmooth = 0;
setGauge(0);                 // cho kim về 0 ngay (→ 240°)
setInterval(pollRPM, 200);   // rồi mới poll


    </script>
  </body>
</html>