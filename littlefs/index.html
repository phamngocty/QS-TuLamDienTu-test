<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ESP32-C3 Quickshifter</title><style>:root{--bg:#0B0F10;--card:#11161A;--muted:#2A3238;--text:#E8EEF2;--sub:#A6B3BD;--accent:#F3C316;--primary:#1E88FF;--danger:#FF4D4D;--ok:#18C37E;--br:14px;--pad:12px;--gap:10px;--shadow:0 6px 16px rgba(0,0,0,.35)}*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0B0F10,#0E1418);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,#0B0F10,#0E1418);padding:14px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid #182127;box-shadow:var(--shadow)}header .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent)}header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}header .sp{flex:1}header .btn-danger{background:var(--danger);border:none;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}main{padding:16px;display:grid;gap:var(--gap);grid-template-columns:1fr}.card{background:var(--card);border:1px solid #1B242B;border-radius:var(--br);padding:var(--pad);box-shadow:var(--shadow)}.tabs{display:flex;gap:8px;margin-bottom:8px}.tab-btn{border:1px solid #22303A;background:#0F151A;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}.tab-btn.active{border-color:var(--primary);box-shadow:0 0 0 2px rgba(30,136,255,.25)}.row{display:grid;gap:var(--gap);grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}label{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--sub)}input,select{background:#0F151A;color:var(--text);border:1px solid #24323B;border-radius:10px;padding:8px 10px;outline:none}input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(30,136,255,.25)}.btn{border:1px solid #22303A;background:#121A1F;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}.btn.primary{border-color:var(--primary);background:#0F1720}.btn.accent{border-color:#F3C316;background:#17160A}.btn.ok{border-color:#18C37E;background:#0F1915}.btn.danger{border-color:#FF4D4D;background:#1C1010}.table{overflow:auto;border-radius:12px;border:1px solid #22303A}table{width:100%;border-collapse:collapse;font-size:13px}th,td{padding:8px 10px;border-bottom:1px solid #1E2A32;text-align:left}pre{white-space:pre-wrap;background:#0A0F12;border:1px solid #1B242B;border-radius:12px;padding:10px;max-height:260px;overflow:auto}.muted{color:var(--sub)}@media(min-width:900px){main{grid-template-columns:1fr 1fr}}</style></head><body><header><div class=dot></div><h1>Tự làm điện tử — Quickshifter</h1><div class=sp></div><button class="btn-danger" id=btnWifiOff>Tắt Wi-Fi</button></header><main><div class=card><div class=tabs><button class="tab-btn active" id=t_qs>Quickshifter</button><button class=tab-btn id=t_bf>Backfire</button><button class=tab-btn id=t_tools>Tools & Logs</button></div><section id=qs><div class=row><label>Mode<select id=mode><option value=0>Manual</option><option value=1>Auto</option></select></label><label>Cut Output<select id=cutout><option value=0>Ignition</option><option value=1>Injector</option></select></label><label>RPM Source<select id=rsrc><option value=0>Coil</option><option value=1>Injector</option></select></label><label>PPR<select id=ppr><option>0.5</option><option selected>1</option><option>2</option></select></label><label>RPM min <input id=rpmmin type=number value=2500></label><label>Manual kill (ms) <input id=mkill type=number value=70></label><label>Debounce shift (ms) <input id=deb type=number value=15></label><label>Hold-off (ms) <input id=hold type=number value=200></label></div><div class=card style=margin-top:10px><h3>Auto Map</h3><div class=table><table><thead><tr><th>Lo</th><th>Hi</th><th>Cut (ms)</th></tr></thead><tbody id=map></tbody></table></div><div style="display:flex;gap:8px;margin-top:8px"><button class="btn accent" id=btnAddRow>Thêm dòng</button><button class="btn ok" id=btnSave>Lưu</button><button class=btn id=btnLoad>Tải</button></div></div></section><section id=bf style=display:none><div class=row><label><span>Enable</span> <input type=checkbox id=bf_en></label><label>Extra cut (ms) <input id=bf_ex type=number value=15></label><label>Min RPM <input id=bf_min type=number value=4500></label></div><div style=margin-top:8px><button class="btn ok" id=btnSaveBF>Lưu</button></div></section><section id=tools style=display:none><div class=row><div class=card><h3>Test Output</h3><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn primary" id=btnTestIgn>Cắt IGN 50ms</button><button class="btn primary" id=btnTestInj>Cắt INJ 50ms</button></div></div><div class=card><h3>Test RPM</h3><div class=row><label>Enable <input type=checkbox id=tr_en></label><label>RPM <input id=tr_rpm type=number value=5000></label><label>PPR <select id=tr_ppr><option>0.5</option><option selected>1</option><option>2</option></select></label></div><div style=margin-top:8px><button class="btn ok" id=btnApplyTR>Apply</button></div></div><div class=card><h3>Calibrate RPM</h3><div class=row><label>RPM thực tế <input id=cal_true type=number></label></div><div style=margin-top:8px><button class="btn ok" id=btnCalib>Calibrate</button></div></div><div class=card><h3>Config</h3><div style="display:flex;gap:8px;flex-wrap:wrap"><button class=btn id=btnExport>Export JSON</button><input class=btn type=file id=f accept=.json><button class=btn id=btnReload>Reload</button></div></div></div><div class=card><h3>Logs</h3><pre id=logs class=muted></pre><div><button class="btn danger" id=btnClearLog>Clear</button></div></div></section></div></main><script>const q=e=>document.querySelector(e),qa=e=>[...document.querySelectorAll(e)];const tabs={qs:q("#qs"),bf:q("#bf"),tools:q("#tools")},tb={qs:q("#t_qs"),bf:q("#t_bf"),tools:q("#t_tools")};function setTab(n){for(const k in tabs){tabs[k].style.display=k===n?"block":"none";tb[k].classList.toggle("active",k===n)}}tb.qs.onclick=()=>setTab("qs");tb.bf.onclick=()=>setTab("bf");tb.tools.onclick=()=>setTab("tools");async function apiGet(p){const r=await fetch(p);return r.ok?r.json():null}async function apiText(p,o){const r=await fetch(p,o);return r.text()}async function hold(){try{await apiText("/api/wifi_hold?on=1",{method:"POST"})}catch(e){}}async function wifiOff(){if(confirm("Tắt Wi-Fi AP ngay?"))await apiText("/api/wifi_off",{method:"POST"})}q("#btnWifiOff").onclick=wifiOff;let cfg={};function renderCfg(){q("#mode").value=cfg.mode;q("#cutout").value=cfg.cut_output;q("#rsrc").value=cfg.rpm_source;q("#ppr").value=cfg.ppr;q("#rpmmin").value=cfg.rpm_min;q("#mkill").value=cfg.manual_kill_ms;q("#deb").value=cfg.debounce_shift_ms;q("#hold").value=cfg.holdoff_ms;q("#bf_en").checked=cfg.backfire_enabled;q("#bf_ex").value=cfg.backfire_extra_ms;q("#bf_min").value=cfg.backfire_min_rpm;let tb=q("#map");tb.innerHTML="";(cfg.map||[]).forEach(b=>{let tr=document.createElement("tr");tr.innerHTML=`<td><input type=number value=${b.lo}></td><td><input type=number value=${b.hi}></td><td><input type=number value=${b.t}></td>`;tb.appendChild(tr)})}function collectCfg(){cfg.mode=+q("#mode").value;cfg.cut_output=+q("#cutout").value;cfg.rpm_source=+q("#rsrc").value;cfg.ppr=parseFloat(q("#ppr").value);cfg.rpm_min=+q("#rpmmin").value;cfg.manual_kill_ms=+q("#mkill").value;cfg.debounce_shift_ms=+q("#deb").value;cfg.holdoff_ms=+q("#hold").value;cfg.backfire_enabled=q("#bf_en").checked;cfg.backfire_extra_ms=+q("#bf_ex").value;cfg.backfire_min_rpm=+q("#bf_min").value;cfg.map=[];document.querySelectorAll("#map tr").forEach(tr=>{let t=tr.querySelectorAll("input");cfg.map.push({lo:+t[0].value,hi:+t[1].value,t:+t[2].value})})}async function load(){const d=await apiGet("/api/get");if(d){cfg=d;renderCfg()}}async function save(){collectCfg();alert(await apiText("/api/set",{method:"POST",body:JSON.stringify(cfg)}))}q("#btnAddRow").onclick=()=>{let tr=document.createElement("tr");tr.innerHTML="<td><input type=number></td><td><input type=number></td><td><input type=number></td>";q("#map").appendChild(tr)};q("#btnSave").onclick=save;q("#btnLoad").onclick=load;q("#btnSaveBF").onclick=save;q("#btnReload").onclick=load;q("#btnExport").onclick=()=>{let s=JSON.stringify(cfg,null,2);let a=document.createElement("a");a.href=URL.createObjectURL(new Blob([s],{type:"application/json"}));a.download="qs_config.json";a.click()};q("#f").onchange=async e=>{let t=await e.target.files[0].text();let r=await apiText("/api/set",{method:"POST",body:t});alert(r);load()};q("#btnTestIgn").onclick=()=>apiText("/api/testcut?out=ign",{method:"POST"});q("#btnTestInj").onclick=()=>apiText("/api/testcut?out=inj",{method:"POST"});q("#btnApplyTR").onclick=()=>{const en=q("#tr_en").checked?1:0;const rpm=q("#tr_rpm").value;const ppr=q("#tr_ppr").value;return apiText(`/api/testrpm?en=${en}&rpm=${rpm}&ppr=${ppr}`,{method:"POST"})};q("#btnCalib").onclick=()=>{const v=q("#cal_true").value;if(!v)return alert("Nhập RPM thực tế");return apiText(`/api/calib?true_rpm=${v}`,{method:"POST"}).then(t=>alert(t))};async function loadLogs(){try{const a=await apiGet("/api/log");if(!a)return;const out=a.map(x=>`[${x.t}] rpm=${x.rpm} cut=${x.cut}ms ${x.auto?"AUTO":"MAN"} ${x.bf?"BF":""} out=${x.out} why=${x.why}`).join("\n");const pre=q("#logs");pre.textContent=out;pre.scrollTop=pre.scrollHeight}catch(e){}}q("#btnClearLog").onclick=()=>apiText("/api/clearlog",{method:"POST"});(async()=>{setTab("qs");await hold();await load();setInterval(loadLogs,1e3)})();</script></body></html>
